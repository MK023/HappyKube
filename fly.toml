# Fly.io configuration for HappyKube
# Optimized for free tier with external NeonDB and Redis Cloud

app = "happykube"
primary_region = "fra"  # Frankfurt - closest to NeonDB (London)

# Build configuration
[build]
  dockerfile = "Dockerfile"

# Environment variables (non-sensitive)
[env]
  APP_ENV = "production"
  APP_NAME = "HappyKube"
  APP_VERSION = "3.0.0"
  DEBUG = "false"
  LOG_LEVEL = "INFO"

  # API Config
  API_HOST = "0.0.0.0"
  API_PORT = "5000"
  API_WORKERS = "1"
  API_TIMEOUT = "120"

  # CORS
  CORS_ENABLED = "true"
  CORS_ORIGINS = "*"

  # Rate Limiting
  RATE_LIMIT_ENABLED = "true"
  RATE_LIMIT_DEFAULT = "100 per minute"

# HTTP service configuration
[http_service]
  internal_port = 5000
  force_https = true
  auto_stop_machines = true   # Free tier: stop when idle
  auto_start_machines = true  # Free tier: start on request
  min_machines_running = 0    # Free tier: allow scaling to 0
  processes = ["app"]

  # Health checks
  [[http_service.checks]]
    grace_period = "30s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/healthz"

# VM resources (512MB needed for API + Bot)
[[vm]]
  memory = '512mb'
  cpu_kind = 'shared'
  cpus = 1

# Secrets are managed via Doppler and set with `fly secrets set`
# Required secrets:
# - DATABASE_URL (NeonDB with ?sslmode=require)
# - REDIS_URL (Redis Cloud with rediss:// for SSL)
# - ENCRYPTION_KEY (32-char Fernet key)
# - API_KEYS (HK_... format)
# - INTERNAL_API_KEY (HK_... format)
# - TELEGRAM_BOT_TOKEN (from @BotFather)
# - GROQ_API_KEY (from Groq console)
#
# Optional secrets:
# - SENTRY_DSN (error tracking)
# - AXIOM_API_TOKEN (logging, EU support Q1 2026)
# - AXIOM_ORG_ID (logging)
